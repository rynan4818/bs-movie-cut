# YouTube ショート動画用 FFmpegオプションについて

YouTube ショート動画用のFFmpegオプションとして以下の２つがあります。

## YouTube Shorts
    -vf crop=x=in_w*0.28:y=0:w=in_h*9/16:h=in_h,scale=w=1080:h=1920,yadif=0:-1:1 -b:v 12M -b:a 384k -ar 48000 -r 60 -g 30 -movflags +faststart -c:a aac -profile:a aac_low -ac 2 -c:v libx264 -profile:v high -bf 2 -coder 1 -pix_fmt yuv420p -vsync cfr -async 1

こちらのオプションは、画面の中央部分(左から画面の幅の28%の位置を左上とした)、縦長(9:16)の動画にします。

切り出し基準点はオプション最初にある`crop=x=in_w*0.28`の`0.28`を変更して位置を変えられます。

![image](https://github.com/rynan4818/bs-movie-cut/assets/14249877/e6f3341a-03a9-4c24-9682-7c1c570a19e0)

## YouTube Shorts Stack
    -filter_complex "[0:v]crop=x=in_w*0.2:y=in_h*0.3:w=in_w*0.4:h=out_w*8/9,scale=w=1080:h=960,yadif=0:-1:1[v0];[0:v]crop=x=in_w*0.6:y=in_h*0.3:w=in_w*0.4:h=out_w*8/9,scale=w=1080:h=960,yadif=0:-1:1[v1];[v0][v1]vstack=inputs=2" -b:v 12M -b:a 384k -ar 48000 -r 60 -g 30 -movflags +faststart -c:a aac -profile:a aac_low -ac 2 -c:v libx264 -profile:v high -bf 2 -coder 1 -pix_fmt yuv420p -vsync cfr -async 1

こちらのオプションは、画面の指定部分２箇所を9:8の比率で切り出して上下に合成し、縦長(9:16)の動画にします。

上側動画の切り出しの基準点はオプションにある`crop=x=in_w*0.2:y=in_h*0.3:w=in_w*0.4`の各数値を変更します。

- x=in_w*0.2 ・・・ 画面左から画面幅の20%の位置を切り出しの左基準とする
- y=in_h*0.3 ・・・ 画面上から画面高の30%の位置を切り出しの上基準とする
- w=in_w*0.4 ・・・ 画面幅の40%を切り出しの幅とする

※切り出しの高さは幅の8/9倍となります。

下側動画は、２つめの`crop=x=in_w*0.6:y=in_h*0.3:w=in_w*0.4`で同様に指定します。

![image](https://github.com/rynan4818/bs-movie-cut/assets/14249877/5ca9e745-cfbf-4387-8df9-8541a120fe8a)

## もっと高度な方法
上の方法は9:16を2分割した9:8の部分を2段重ねしましたが、もっと自由に切り出すには以下の方法があります。

（こちらはデフォルトオプションに入れていません）

![image](https://github.com/rynan4818/bs-movie-cut/assets/14249877/f6835425-b61b-444a-b7d5-18b5a1b5b2bb)

    -filter_complex "[0:v]crop=x=in_w*0.15:y=in_h*0:w=in_w*0.5:h=in_h*1,scale=w=1080:h=1216,yadif=0:-1:1[v0];[0:v]crop=x=in_w*0.65:y=in_h*0.2:w=in_w*0.25:h=in_h*0.8,setsar=1,pad=x=-1:aspect=1080/704,scale=w=1080:h=704,yadif=0:-1:1[v1];[v0][v1]vstack=inputs=2" -b:v 12M -b:a 384k -ar 48000 -r 60 -g 30 -movflags +faststart -c:a aac -profile:a aac_low -ac 2 -c:v libx264 -profile:v high -bf 2 -coder 1 -pix_fmt yuv420p -vsync cfr -async 1

元の動画が 1920*1080 とすると in_w=1920,in_h=1080となるので
### 上動画
- x=1920*0.15 => 288
- y=1080*0    => 0
- w=1920*0.5  => 960
- h=1080*1    => 1080

出力動画の幅を1080(out_w)とすると、出力動画の高さは1080(out_w)*1080(h)/960(w)=1215(out_h)となるが、解像度は偶数が必須なので1216とする
- scale=w=1080:h=1216
### 下動画
- x=1920*0.65 => 1248
- y=1080*0.2  => 216
- w=1920*0.25 => 480
- h=1080*0.8  => 864

出力動画の高さ(out_h)は、1920から上動画の1216を引いて704になる

下動画の比率480(w):864(h)に対して、出力動画は1080(out_w):704(out_h)で左右に余白が必要なので

動画の縦幅固定で中央に配置して、左右に余白を追加
- setsar=1,pad=x=-1:aspect=1080/704

最後に出力動画のサイズを指定
- scale=w=1080:h=704

※filter_complexを駆使すると、３箇所を切り出して合成とかも可能です。filter_complexの説明は[こちら](https://techblog.morphoinc.com/entry/2020/07/20/100009)や[こちら](https://techblog.morphoinc.com/entry/2020/07/21/100022)など参考になります。一般的な解説だと別々の動画を入力している例が多いですが、今回の様に１つの動画を入力にして複数切り出して合成も同じ手順で可能です。

# 音ズレについて
PCで録画を行うと様々な原因で音ズレが発生しますが、カット前の元動画でズレておらず、
カットツールで切り出しを行う際にズレが発生する場合の対処法を記載します。

カット時の音ズレは、主にffmpegオプションをDEFALUTの -c copy (無劣化) オプションで実施する場合に発生しやすい様です。

ちなみに私の場合、録画はOBS Studioで下記の様な標準的な設定で行っています。

![image](https://user-images.githubusercontent.com/14249877/130332669-18e365a4-4e0f-4bf6-81d9-403387c46bce.png)

また、再生プレーヤーは
* [MPC-BE](https://sourceforge.net/projects/mpcbe/)
* bs-movie-cutでプレビュー用にインストールされるffplay.exe

で動作確認しており、この環境では音ズレは発生していません。

ただし、Windows標準のメディアプレーヤーなどでは、映像と音声共に再エンコードしないと正しく再生されないようです。
下記の③のNVENC_Acopyもダメで、Twitter用やYoutube用の映像・音声共にエンコードしたものなら大丈夫でした。
copyオプションを使いつつ、どのプレーヤーでも正常に再生できる動画カットの方法はどこかにあるのかもしれませんが、ffmpegのオプションは膨大で調べきれておりません。

現状、人に渡す動画を作る場合にはcopyオプションは使わずに、映像・音声共にエンコードしたものを使用した方が間違い有りません。

## ① -async 1 オプション
-async 1 オプションを追加すると、映像と音声を最初に同期させる処理を行うため、音ズレが解消される場合があります。
- DEFALUT (無劣化コピー)
   -  -c copy **-async 1**
- Twitter (Twitter 投稿用)
   - -vcodec libx264 -pix_fmt yuv420p -strict -2 -acodec aac -ab 256k -vb 10240k **-async 1**

## ② キーフレーム単位でカットする
今回の更新で追加した、キーフレーム単位でカットする機能を有効にして、-c copy(無劣化) で切り出しを行うと、音ズレが解消される可能性があります。ただし、動画の長さが指定範囲よりも前後に多少長くなります。

なお、キーフレーム単位でカットするのは、映像の無劣化copy時のみ対象です。(エンコード時はその必要がないため)
キーフレーム単位でカットした方が再生互換性が高くなるため、多少動画が長くなっても構わないならば、音ズレが無くても有効にした方が良いと思います。

- 解説
   - 映像は時間軸方向に圧縮しているため、数秒毎に挿入されるキーフレームが無いと表示することが出来ません。そのため、無劣化ではキーフレーム単位でしか編集ができません。ただし、mp4等の動画形式では指定箇所から再生する機能があり、直近のキーフレームから格納して、実際の再生は指定時間から開始させることで任意の場所でカットしたように見せることが出来るようです。しかし再生プレーヤーが対応していないと上手く処理できず、また音声は指定時間からしか格納されていないため、再生時に上手く同期できないと音ズレの原因になるようです。

## ③ エンコードをする
エンコードを実施すると、音ズレが解消する可能性が高いです。また、可変フレームレート(VFR)だと編集時に音ズレの原因になる様です。
下記設定はVFRを固定フレーム(CFR)に変換し、なるべく劣化を抑えるために映像のみエンコードし、NVIDIAのグラフィックボードの機能を使って高速にエンコードする設定です。
- NVENC_Acopy
  -  -r 60 -vsync cfr -async 1 -c:a copy -vcodec h264_nvenc -vb 22M
        - -r 60 はフレームレートです 30にすると30fpsになります。 -vb 22Mはビットレートです。保存形態に合わせて調整してください。
